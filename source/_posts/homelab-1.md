---
title: Homelab 折腾记 E02 - 软路由和局域网
tags:
  - Homelab
  - 软路由
  - 网络
categories:
  - Homelab
date: 2024-02-01 18:23:05
---


## 万恶之源 - 软路由

我住在一个不到40平的小出租屋里，办理了一个电信的 1000M 宽带。电信给的光猫性能其实足够日常使用了，但是哪能挡得住折腾的心呢？

### 桥接 vs 路由

光猫中分为路由和桥接两种模式。

路由模式：路由模式下光猫将充当一个路由器的角色，自身在拨号后为下游设备提供互联网链接，提供 DHCP 协议来分发IP地址以及 NAT 。如果我们需要在下游继续配置路由器， NAT 层数会越来越多，影响网络的性能。日常使用情况下直接使用光猫自带的 WiFi 功能以及机身上的三个千兆口就非常足够了。

桥接模式：桥接模式下光猫主要的责任就是光电转换，以及充当一个二层交换机的角色，下游的设备都需要自行 PPPoE 拨号来获得互联网连接，这样我们在架设局域网时可以减少一层 NAT 转发，某种程度上可以优化网络性能。

将光猫改为桥接模式很简单，找宽带师傅或者客服要来超级密码，登录光猫的超级管理员将路由模式改为桥接模式就行，网上有很多教程。

实际上现在有很多人甚至不信任光猫的性能，会用猫棒来代替光猫实现光电转换，因为每个地区的运营商使用的方案都不太一样，需要的光模块之类的设备也不太一样，因此这里就不说了，我也没打算用。

### 硬件选择

在刚开始折腾 Homelab 那会，软路由配置的主流还是 N5105 和 J1900 之流。在某宝上充斥着各种小体积被动散热的 N5105/J1900 带4-6个 2.5G 网口的小主机，价格也不贵，于是我就顺理成章地选了一台：

```
- CPU: N5105 4核4线程
- 内存: 32G DDR4
- 硬盘: 512G NVME SSD
- 网卡: Intel i226-V 2.5G x4
```

至于说为啥装了这么多的内存和硬盘，以后再说；）

这台机器的性能单纯拿来做路由器来说绝对是够用的，在安装了 OpenWRT 之后还可以跑一些其他的服务，比如 OpenClash 和 KMS 之类的。

### 操作系统

实际上除了OpenWRT，还可以选择其他很多类似的产品，比如 pfSense 和 OPNsense 之类的。但是这些产品没有像OpenWRT那么丰富的第三方插件可以选择，而且 pfSense 和 OPNsense 更加注重于防火墙方面，对于我的需求来说 OpenWRT 再适合不过了。

安装过程其实很简单：

1. 下载 OpenWRT 的镜像文件，中国大陆地区用户如果访问[官网](https://openwrt.org/downloads)很慢可以去国内各个大学和互联网公司提供的镜像站，比如[中科大](https://mirrors.ustc.edu.cn/openwrt/)和[清华大学](https://mirrors.tuna.tsinghua.edu.cn/openwrt/)；

2. 将 SSD 装在你的电脑或者硬盘盒里；

3. 用 `balenaEtcher` 或 Linux 下的 `dd` 将镜像写入 SSD；

4. 将 SSD 装入软路由主机里，直接开机。

如果电脑里没有多余的 SSD 插槽或者没有合适的硬盘盒，可以这样操作：

1. 找一个空闲的U盘，写入一个可引导的 Linux 系统，比如 [Alpine Linux](https://www.alpinelinux.org/downloads/) ；

2. 把 OpenWRT 的镜像文件复制到这个U盘上；

3. 在软路由上引导这个U盘，进入到U盘中的 Linux 系统；

4. 使用 `dd` 将 OpenWRT 的镜像文件写入 SSD。
```bash
$ sudo dd if=/path/to/openwrt.img of=/dev/nvme0n1 bs=4M
```

5. 重启软路由，拔掉U盘，进入 OpenWRT。

### 局域网配置

首先配置一下局域网：

首先准备好一台二层交换机。我从某宝买了一台 TP-LINK 的 TL-SH1008 ，拥有 8 个 2.5G 网口，买的时候差不多 480 块左右。

从软路由的 2.5G 网口牵一条网线出来到交换机的 2.5G 网口，然后再从交换机把其他的设备，比如说 AP 和台式机啥的接好，一个最基本的局域网就形成了。

给自己的机器先配置一个静态 IP 地址，比如 `192.168.1.120` ，因为我们此时并没有配置 DHCP 服务来动态分配 IP 地址。先登录软路由，用 `passwd` 设置一下 root 用户的密码，尽量复杂一点，然后尝试在浏览器上访问 OpenWRT 的默认地址 `192.168.1.1` ，如果能够正常访问则说明之前的配置都是正确的。

登录之后，首先修改一下默认的 LAN 地址，因为默认的地址和很多家用 AP 的默认地址都是一样的，为了避免冲突，我们可以把它改成 `192.168.1.254` ，这样就不会和其他设备冲突了。改好并保存之后从浏览器访问新配置的地址，如果可以正常访问则说明配置成功。

配置好之后，默认情况下 DHCP 服务器和 DNS 服务器都是正常工作的，一般情况下可以不需要额外的配置了。

### 互联网配置

接下来配置一下互联网：

从配置好桥接的光猫的网口上牵一根网线到软路由的网口上，插好之后可以看看网口的灯是否亮起而且偶尔闪烁，如果有说明物理连接是正常的。

进入软路由的 Web UI 主页，看看有哪些端口处于连接的状态。假设光猫的网口是千兆口，那么软路由这端的协商速度应该也是千兆，可以在端口信息中找找是否有一个端口连接了设备，并且协商了 1000M 的速率。

到网络 -> 接口 -> WAN -> 编辑 -> 常规设置 -> 设备 -> 选择刚才的物理端口。然后将协议改为 PPPoE ，并且填写你的宽带账号和密码，然后点击保存并应用。这样软路由就会自动拨号。如果拨号成功，可以看到 WAN 口获取到一个公网 IP 地址，也就代表你有基本的互联网连接了。

## 最后

实际上走完这一篇，一个基本的软路由已经配置好了。但是软路由的精髓并不在于这点基础功能，而在于 OpenWRT 提供的丰富的第三方插件。后面我会详细介绍一些可以在 OpenWRT 上安装的实用的插件，以及在自己的局域网中搭建的一些复杂的服务。